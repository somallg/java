# PLT.12 Portlet Responses
* The response objects encapsulate all information to be returned from the Portlet to the Portlet container during a request: a redirection, a portlet mode change, title, content, etc...
* The portal/portlet-container will use this information to construct the response - usually a portal page - to be returned to the client
* Response object is passed to the *processAction*, *processEvent*, *serveResource* and the *render* methods of the Portlet

## PLT.12.1 PortletResponse Interface
* *PortletResponse* interface defines the common functionality for the *ActionResponse*, *EventResponse*, *ResourceResponse* and *RenderResponse* interfaces

### PLT.12.1.1 Response Properties
* Properties can be used by Portlets to send vendor specific information to portal/portlet-container
* Portlet can set properties using the following methods of *PortletResponse*:
    * setProperty (overwrite existing value)
    * addProperty
* Response properties can be viewed as header values set for the portal application
* If these header values are intended to be transmitted to the client, they should be set before the response is committed:
    * Set the header in the render headers part
    * Override the *GenericPortlet.doHeaders* method
* Note that headers set on the response are not guaranteed to be transported to the client as the portal may restrict headers due to security reasons
 
### PLT.12.1.2 Encoding of URLs
* Portlets may generate content with URLs referring to other resources within the portlet application, such as servlets, JSPs, images and other static files
* Some portal/portlet container implementations may require those URLs to contain implementation specific data encoded in it
* Because of that, Portlets should use the *encodeURL* method to create such URLs
* Resources that are addressed not by an URL encoded with *encodeURL*, or directly via a *ResourceURL*, are not guaranteed to be accessible
* The returned URL might not be a well formed URL but a special token at the time the Portlet is generating its content
* The outcome of the *encodeURL* call may be different than calling *encodeURL* in the Servlet world

### PLT.12.1.3 Namespacing
* Within their content, Portlet may include elements that must be unique within the whole portal page (example JavaScript functions and variables)
* *getNamespace* method must provide the portlet with the mechanism that ensures the uniqueness of the returned string in the whole portal page
* *getNamespace* method must return a valid identifier as defined in the 3.8 of the Java Language Spec

### PLT.12.1.4 Setting Cookies
* Portlet can set HTTP cookies at the response via the *addProperty* method with a *javax.servlet.http.Cookie* as parameter
* Portal is not required to transfer the cookie to the client. Thus Portlet should not assume that it has access to the cookie on the client or that request triggered with URLs not generated by the Portlet API can access the cookie
* Cookies set in the response of one lifecycle call should be available to the portlet in the subsequent lifecycle calls, e.g setting a cookie in *processAction* should enable the portlet to retrieve the cookie in the next *render* call
* For request triggered via portlet URLs portlet should receive back the cookie via *request.getCookies* method
* Cookies are properties and all restrictions said above about properties also apply for cookies, i.e to be successfully transmitted back to the client, cookies must be set before the *response* is committed
* When setting cookies in the render lifecycle phase, Portlet should:
    * Set cookies in the render headers parts
    * Override the *GenericPortlet.doHeaders* method
    
## PLT.12.2 StateAwareResponse Interface
* *StateAwareResponse* interface extends *PortletResponse* interface and in addition provides methods to set new render parameters, a new portlet mode, or window state
* *ActionResponse* and *EventResponse* both extend this interface

### PLT.12.2.1 Render Parameters
* Using *setRenderParameter* and *setRenderParameters* methods Portlets may set render parameters (overwrite any parameter with the same name previously set)
* Subsequent lifecycle calls, like *processEvent* or *render* that are part of the current client request should contain newly set render parameters
* If no other requests occur which influence render parameters, like subsequent *processEvent* calls of this client request, these parameters will be used in all subsequent render requests until a new client request or event targets the Portlet
* Portlet developer do not need to *x-www-form-urlencoded* encode render parameters names and values set in the *StateAwareResponse*
* *removePublicRenderParameter* return public render parameter

### PLT.12.2.2 Portlet Modes and Window State Changes
* *setPortletMode* change current portlet mode
* The new portlet mode will be effective in the following *processEvent* and *render* requests
* *PortletModeException* will be thrown if the Portlet attempts to set a Portlet mode that it is not allowed to switch to
* *setWindowState* change current portlet state
* Portlets cannot assume that subsequent *processEvent* or *render* calls, will be called with the set portlet mode or window state as the portal/portlet container could override these changes
* If the portlet does not set a new portlet or window state at the *StateAwareResponse* interface the current portlet mode and window state are preserved

### PLT.12.2.3 Publishing Events
* *setEvents* allow Portlets to publish event
* Valid to call *setEvent* multiple times in the current *processAction* or *processEvent*

### PLT.12.3.1 Redirection
* *sendRedirect(String)* method instructs the portal/portlet container to set the appropriate headers and content body to redirect the user to a different URL
* A fully qualified URL or a full URL must be specified. If a relative URL is given, an *IllegalArgumentException* must be thrown
* If *sendRedirect(String)* method is called after the *setPortletMode*, *setWindowState*, *removePublicRenderParameter*, *setRenderParameter*, or *setRenderParameters* methods of the *ActionResponse* interface, an *IllegalStateException*  must be thrown and the redirection must not be executed
* same for *sendRedirect(String location, String renderUrlParamName)*
* Portlet container must attach a render URL with the currently set portlet mode, window state and render parameters on the *ActionResponse* and the current public render parameters
* The attached URL must be available as query parameter value under the key provided with the *renderUrlParamName* parameter
* Sending events when doing a redirect is discouraged as these events may be discarded by the portal/portlet container

## PLT.12.4 EventResponse Interface
* *EventResponse* interface extends the *StateAwareResponse* interface and adds additional method *setRenderParameters(EventRequest)*

## PLT.12.5 MimeResponse Interface
* *MimeResponse* interface extends the *PortletResponse* interface and is used as base interface for *RenderResponse* and *ResourceResponse*
* *MimeResponse* provides the functionality to create MIME-based content that is returned to the Portal application

### PLT.12.5.1 Content Type
* Portlet can set the content type of the response using the *setContentType* method of the *MimeResponse* interface in order to indicate to the portlet container which content type the portlet has chosen
* *setContentType* method must throw an *IllegalArgumentException* it the content type set does not match (including wildcard matching) any of the content types returned by the *getResponseContentType* method of the *PortletRequest* object
* *setContentType* method must be called before the *getWriter* or *getPortletOutputStream* methods. If called after, it should be ignored
* If the Portlet has a content type, the *getContentType* must return it, otherwise *getContentType* must return *null*
* If the portlet does not specify a content type before the *getWriter* or *getPortletOutputStream*, the portlet container assumes the content type of the *PortletRequest.getResponseContentType()* method and resolves wildcards on the best-can-do basis

### PLT.12.5.2 Output Stream and Writer Objects
* Portlet may generate its content by writing to the *OutputStream* or to the *Writer* of the *MimeResponse* object
* Portlet must use only one of these objects. The Portlet container must throw an *IllegalStateException* if a Portlet attempts to use both
* The termination of *render* or *serveResource* method of the Portlet indicates that the Portlet has satisfied the request and the output buffer is to be flushed
* In *render*, the raw *OutputStream* is available because of some servlet container implementations requirements and for portlets that do not generate markup fragments
* Portlets should only use the raw *OutputStream* for binary content and *Writer* for text-based markup
* If Portlet uses *OutputStream*, Portlet is responsible for using the proper character encoding

### PLT.12.5.3 Access to Response Headers
* Portlet can set HTTP headers for the response via the *setProperty* or *addProperty* method in the *MimeResponse*
* Headers must be set before the response is committed
* Note that it is not guaranteed that headers, like cookies, will be transmitted all the way back to the client

### PLT.12.5.4 Setting Markup Head Elements
* Use *addProperty* with *MimeResponse.MARKUP_HEAD_ELEMENT* as property name and an *org.w3c.dom.Element* value
* This property is intended to be a hint to the portal application that is provided DOM element should be added to the markup head section of the response the the client
* Check for *MARKUP_HEAD_ELEMENT_SUPPORT* property on the *PortalContext* for support for this  property
* Even if the calling Portal supports this property, delivery of DOM element to the client is not guaranteed, e.g due to possible security rules of the portal application
# For render calls, Portlets should set head properties in the render headers part of the render lifecycle phase or simple override *GenericPortlet.doHeaders* method

### PLT.12.5.5 Buffering
* Portlet container is allowed, but not required, to buffer output going to the client for efficiency purposes
* Typically servers that do the buffering make it the default, but allow portlets to specify buffering parameters
* The following methods in the *MimeResponse* interface allow Portlet to access and set buffering information:
    * getBufferSize
    * setBufferSize
    * isCommitted (check whether any response bytes have been returned to the client)
    * reset (clear data in the buffer when the response is not committed, properties set by the Portlet must be cleared as well)
    * resetBuffer (clears content in the buffer if the response is not committed without clearing the properties)
    * flushBuffer (forces content in the buffer to be written to the client)
* These method allow buffering operations to be performed whether Portlet is using an *OutputStream* or a *Writer*
* Buffer size must be as large as the size requested
* The method should be called before any content is written using a *OutputStream* or *Writer*
* If any content has been written, this method may throw an *IllegalStateException*
* When using a buffer, the container must immediately flush the content of a filled buffer to the portal application

### PLT.12.5.6 Predefined MimeResponse Properties
* *MimeResponse* interface defines some property name that allow Portlets leveraging these extensions to inter-operate across different portal/portlet container

#### PLT.12.5.6.1 Cache properties
* *MimeResponse* defines the property names *CACHE_SCOPE*, *EXPIRATION_CACHE*, *ETAG* AND *USE_CACHE_CONTENT*, and property value *PRIVATE_SCOPE* AND *PUBLIC_SCOPE*, used for validating expired content, setting new expiration times and cache scopes

#### PLT.12.5.6.2 Namespaced Response Property
* *NAMESPACED_RESPONSE* hint to the portal that the returned content is completely namespaced, this includes all markup id elements, form fields, etc..

## PLT.12.6 RenderResponse Interface
* *RenderResponse* interface extends *MimeResponse* interface and it is used in the *render* method of the *Portlet* interface
* This allows a Portlet to set its title, next possible portlet modes, and generate content
* Portlet cannot set the character encoding or the locale of the response as these are pre-set by the portal/portlet container

### PLT.12.6.1 Portlet Title
* Portlet may indicate to the portal/portlet container its preferred title
* It is up to the portal/portlet-container to use the preferred title set by the portlet
* *setTitle* method must be called before the output of the portlet has been committed, if called after it should be ignored
* set *javax.portlet.renderHeaders* container runtime option and either set the title in the render headers part or override *GenericPortlet.getTitle* method

### PLT.12.6.2 Next possible portlet modes
* Portlet may indicate to the portal the next possible portlet mode that make sense from the portlet point of view via the *setNextPossiblePortletModes* method
* If set, the portal should honor these enumeration of portlet modes and only provide end user with choices to the provided portlet modes or a subset of these modes based on access control considerations
* If portlet does not set any next possible modes, the default is that all portlet modes that the portlet defined supporting are meaningful new portlet modes
* Portlet should set *javax.portlet.renderHeaders* container runtime option and either set the next possible modes in the render headers part of the render lifecycle phase or simply override *GenericPortlet.getNextPossiblePortletModes* method

## PLT.12.7 ResourceResponse Interface
* *ResourceResponse* interface extends *MimeResponse* interface and is used in the *serveResource* method of the *ResourceServingPortlet*
* This interface allows Portlet to generate content that is directly served to the client, including binary content
* Portlet can set character encoding or the locale of the response
* Portal/portlet container may pre-set character encoding and locale

### PLT.12.7.1 Setting the Response Character Set
* Portlet can change character encoding for resource response in several ways:
    * setCharacterEncoding
    * setContentType (only if given content type string provides value for *charset* attribute)
    * setLocale and locale-encoding-mapping-list in *web.xml* (call to *setLocale* only if neither *setCharacterEncoding* nor *setContentType* has set the character encoding before)
* If Portlet does not set character encoding before *getWriter*, UTF-8 is applied by the portlet container as default character encoding

## PLT.12.8 Lifetime of Response Objects
* Each response object is valid only within the scope of a particular *processAction*, *processEvent*, *serveResource*, or *render* method call
* Container commonly recycle response objects in order to avoid the performance overhead of response object creation
* Developer must be aware that maintaining references to response objects outside the scope described above may lead to non-deterministic behavior
